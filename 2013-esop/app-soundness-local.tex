%!TEX root = ./recycling.tex
%
% app-soundness-local.tex



\section{Soundness for the Local Fragment}\label{sec:soundloc}

\newcommand{\safeloccond}[1]{\noindent\textbf{\safelocref{#1}}}
\newcommand{\safelocref}[1]{Condition~(\ref{safeloc:#1})} %{Def.~\ref{def:safe}(\ref{safeloc:#1})}
%\newcommand{\emptyhistory}{\epsilon}

\begin{defin}[Extend Local Worlds]\label{def:extlocworld}
  An \emph{extended local world}  
  is an extended world $\upomega=(\theta,\eta\unit,\intp,\emptyset,\emptyset, \true, q)$ such that
  the current shared state is empty, 
  the rely and guarantee sets are empty,  
  the temporal invariant is $\true$, 
  and $q$ is an assertion on states. 
\end{defin}

\begin{defin}[Local Configurations]\label{def:localconfig}
  A \emph{local configuration}  is a configuration of the form
  $\kappa=(C,\theta,\eta\unit,\intp,\emptyset,\emptyset, \true, q)$  
  such that $C$ is a command which does not contain atomic blocks 
  and $(\theta_l,\eta\unit,\intp,\emptyset,\emptyset,\true, q)$ is an extended local world.
\end{defin}  

\begin{defin}[Bounded Safety for Local  Configurations]\label{def:safelocal}
  A local configuration  $\kappa = (C,\theta,\eta\unit,\intp,\emptyset,\emptyset,\true, q)$ 
  is always \emph{locally safe for $0$ steps}, denoted 
  $
   \safe^L_0(\kappa)\,.
  $
  $\kappa$ is \emph{locally safe for $n + 1$ steps},  
  denoted 
  $
   \safe^L_{n+1}(\kappa)\,,
  $
  if the following  holds
  \begin{compactenum}[(a)]
    \item \label{safeloc:done} if 
     $C = \done$ then $\theta,\intp \vDash q$,
     
    \item \label{safeloc:noabort}  
     for all $\theta_f$ if $\consistent{\theta*\theta_f}$ then 
     $C,\theta*\theta_f \not\rightarrow \top$,  
     
    \item \label{safeloc:step} whenever $C,\theta*\theta_f \rightarrow C',\theta'$ 
     \begin{compactenum}[(1)] 
        \item 
        \label{safeloc:step:frame}
		there exists  $\theta''$ such that $\theta'=\theta''*\theta_f$ and       
        \item 
        \label{safeloc:step:ind}
        it holds that  $\safe_{n}(C',\theta'',\eta\unit,\intp,\emptyset,\emptyset,\true,q)$.       
  	 \end{compactenum}
  \end{compactenum}
  A local configuration $\kappa$ is safe, denoted $\safe^L(\kappa)$, if it is safe for any $0 \leq n$ steps.
\end{defin}

\begin{defin}[Local Meaning of triples]\label{def:semtriple}
$\emptyset,\emptyset,\true \vDash_L \{ p \} \, c \, \{ q \}$ if and only if 
every local configuration $\kappa = (C,\theta,\eta\emp,\intp,\emptyset,\emptyset,\true, q)$
such that 
$\theta,\intp \vDash P$ it holds that $\safe^L(\kappa)$.
\end{defin}

\begin{lemma}
For local configuration $\kappa = (C,\theta,\eta\unit,\intp,\emptyset,\emptyset,\true, q)$ 
it holds that
$\safe(\kappa)$ if and only if $\safe^L(\kappa)$.
\end{lemma}

\begin{proof}
Definition~\ref{def:safelocal} is a simplification of Definition~\ref{def:safe}
for local configurations.
\end{proof}

\begin{theorem}[Grace logic locally is sound for local configurations]
  If  $\emptyset,\emptyset,\true \vdash \{ p \} \, C \, \{ q \}$  
  then
  $\emptyset,\emptyset,\true \vDash_L \{ p \} \, C \, \{ q \}$\,.
\end{theorem}

\begin{sketch}
The proof is done by induction following the line of the general soundness proof, but using the simplified definition safety (Definition~\ref{def:localconfig}). 
\end{sketch}

\begin{lemma}[Properties of Runs of Local Configurations]\label{lem:safeloc:run}
  Let  $\kappa = (C,\theta,\eta\unit,\intp,\emptyset,\emptyset,\true, q)$ 
  be a safe local configuration.
  For any $\theta_f$ such that $\consistent{\theta*\theta_f}$ it holds that
  \begin{compactenum}
    \item \label{lem:safeloc:noabort} 
    $\neg(C,\theta,\intp \rightarrow^* \top)$ and
    \item \label{lem:safeloc:post} if 
      $C,\theta,\intp \rightarrow^* \done,\intp,\theta',\intp$
    then there exists $\theta''$ such that $\theta' = \theta'' * \theta_f$
    and $\theta'',\intp \vDash q$.
%    
%    $\eta' = \eta\unit$,
%    $\intp' = \intp$,
%    $R' = G' = \emptyset$, and
%    $\Upsilon = \true$. 
  \end{compactenum}
\end{lemma}

 

